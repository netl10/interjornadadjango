{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}Histórico de Acessos{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .stats-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-item {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9em;
    }
    
    .filters {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .filters form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    
    .filters .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .filters label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #495057;
    }
    
    .filters input, .filters select {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .filters button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .filters button:hover {
        background: #0056b3;
    }
    
    .logs-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .logs-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .logs-table th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: bold;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .logs-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .logs-table tr:hover {
        background: #f8f9fa;
    }
    
    .event-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        color: white;
    }
    
    .event-entry { background: #28a745; }
    .event-exit { background: #dc3545; }
    .event-denied { background: #ffc107; color: #212529; }
    .event-error { background: #6c757d; }
    .event-timeout { background: #fd7e14; }
    .event-maintenance { background: #20c997; }
    .event-authorized { background: #007bff; }
    .event-blocked { background: #6f42c1; }
    
    .portal-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        color: white;
    }
    
    .portal-1 { background: #28a745; }
    .portal-2 { background: #dc3545; }
    
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    
    .pagination a, .pagination span {
        padding: 8px 12px;
        margin: 0 2px;
        border: 1px solid #dee2e6;
        color: #007bff;
        text-decoration: none;
        border-radius: 4px;
    }
    
    .pagination .current {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .pagination a:hover {
        background: #e9ecef;
    }
    
    .no-logs {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .breadcrumb {
        background: none;
        padding: 0;
        margin-bottom: 20px;
    }
    
    .breadcrumb a {
        color: #007bff;
        text-decoration: none;
    }
    
    .breadcrumb a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumb">
    <a href="{% url 'admin:index' %}">Início</a> &rsaquo;
    <a href="{% url 'admin:logs_accesslog_changelist' %}">Logs de Acesso</a> &rsaquo;
    Histórico
</div>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-item">
        <div class="stat-number">{{ total_logs }}</div>
        <div class="stat-label">Total de Logs</div>
    </div>
    <div class="stat-item">
        <div class="stat-number">{{ today_logs }}</div>
        <div class="stat-label">Logs Hoje</div>
    </div>
    <div class="stat-item">
        <div class="stat-number">{{ event_stats|length }}</div>
        <div class="stat-label">Tipos de Evento</div>
    </div>
    <div class="stat-item">
        <div class="stat-number">{{ portal_stats|length }}</div>
        <div class="stat-label">Portais Ativos</div>
    </div>
</div>

<div class="filters">
    <form method="get">
        <div class="form-group">
            <label for="search">Buscar:</label>
            <input type="text" id="search" name="search" value="{{ search }}" placeholder="Usuário, ID ou Log ID">
        </div>
        
        <div class="form-group">
            <label for="event_type">Evento:</label>
            <select id="event_type" name="event_type">
                <option value="">Todos</option>
                {% for event_id, event_name in event_types %}
                <option value="{{ event_id }}" {% if event_type == event_id|stringformat:"s" %}selected{% endif %}>
                    {{ event_name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="portal_id">Portal:</label>
            <select id="portal_id" name="portal_id">
                <option value="">Todos</option>
                <option value="1" {% if portal_id == "1" %}selected{% endif %}>Portal 1 (Entrada)</option>
                <option value="2" {% if portal_id == "2" %}selected{% endif %}>Portal 2 (Saída)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="date_from">Data Inicial:</label>
            <input type="date" id="date_from" name="date_from" value="{{ date_from }}">
        </div>
        
        <div class="form-group">
            <label for="date_to">Data Final:</label>
            <input type="date" id="date_to" name="date_to" value="{{ date_to }}">
        </div>
        
        <div class="form-group">
            <label for="user_id">ID do Usuário:</label>
            <input type="text" id="user_id" name="user_id" value="{{ user_id }}" placeholder="Ex: 1">
        </div>
        
        <div class="form-group">
            <button type="submit">Filtrar</button>
        </div>
    </form>
</div>

{% if page_obj %}
<div class="logs-table">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Usuário</th>
                <th>Evento</th>
                <th>Portal</th>
                <th>Data/Hora</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for log in page_obj %}
            <tr>
                <td>{{ log.device_log_id }}</td>
                <td>
                    <strong>{{ log.user_name }}</strong><br>
                    <small>ID: {{ log.user_id }}</small>
                </td>
                <td>
                    <span class="event-badge event-{{ log.get_event_type_display|lower|cut:' ' }}">
                        {{ log.get_event_type_display }}
                    </span>
                </td>
                <td>
                    <span class="portal-badge portal-{{ log.portal_id }}">
                        Portal {{ log.portal_id }}
                    </span>
                </td>
                <td>{{ log.display_device_timestamp }}</td>
                <td>
                    <span class="event-badge {% if log.processing_status == 'processed' %}event-authorized{% else %}event-denied{% endif %}">
                        {{ log.get_processing_status_display }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if page_obj.has_other_pages %}
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?page=1{% if search %}&search={{ search }}{% endif %}{% if event_type %}&event_type={{ event_type }}{% endif %}{% if portal_id %}&portal_id={{ portal_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}">&laquo; Primeira</a>
        <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if event_type %}&event_type={{ event_type }}{% endif %}{% if portal_id %}&portal_id={{ portal_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}">Anterior</a>
    {% endif %}
    
    <span class="current">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
    </span>
    
    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if event_type %}&event_type={{ event_type }}{% endif %}{% if portal_id %}&portal_id={{ portal_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}">Próxima</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if event_type %}&event_type={{ event_type }}{% endif %}{% if portal_id %}&portal_id={{ portal_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}">Última &raquo;</a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="no-logs">
    <h3>Nenhum log encontrado</h3>
    <p>Tente ajustar os filtros de busca.</p>
</div>
{% endif %}

{% if event_stats %}
<div class="stats-card">
    <h3>Estatísticas por Evento</h3>
    <div class="stats-grid">
        {% for event_name, count in event_stats.items %}
        <div class="stat-item">
            <div class="stat-number">{{ count }}</div>
            <div class="stat-label">{{ event_name }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if portal_stats %}
<div class="stats-card">
    <h3>Estatísticas por Portal</h3>
    <div class="stats-grid">
        {% for portal_name, count in portal_stats.items %}
        <div class="stat-item">
            <div class="stat-number">{{ count }}</div>
            <div class="stat-label">{{ portal_name }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if top_users %}
<div class="stats-card">
    <h3>Usuários Mais Ativos</h3>
    <div class="stats-grid">
        {% for user_name, count in top_users.items %}
        <div class="stat-item">
            <div class="stat-number">{{ count }}</div>
            <div class="stat-label">{{ user_name }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% endblock %}
